# F1.5: Simple Halftone Patterns - Detailed Planning

**Status:** PLANNING
**Priority:** P0
**Started:** 2025-01-19

---

## 1. Feature Overview

Implement three simple, immediately usable halftone patterns to provide functional patterns while more complex SDF patterns are developed. These patterns will use the existing size specification, export, and analysis infrastructure from F1.

**Patterns to implement:**
1. **Random Pattern** - Pure random pixel values
2. **Noise Pattern** - Perlin/Simplex noise with configurable parameters
3. **Ben-Day Dots** - Regular dot grid with configurable spacing and size

---

## 2. Detailed Requirements

### 2.1 Random Pattern

**Description:** Each pixel is assigned a random grayscale value (0-255).

**Parameters:**
- Seed (optional) - for reproducible randomness
- Distribution type:
  - Uniform (default) - equal probability across 0-255
  - Normal - gaussian distribution around 128
  - Binary - only 0 or 255 (pure black/white noise)

**Use Cases:**
- Testing analysis tool
- Film grain effects
- Texture generation

**Implementation Notes:**
- Use `Math.random()` or seedable PRNG for reproducibility
- Fast generation - direct pixel assignment
- No spatial coherence

---

### 2.2 Noise Pattern

**Description:** Smooth, continuous noise using Perlin or Simplex noise algorithm.

**Parameters:**
- **Scale/Frequency** (0.1 - 10.0, default: 1.0)
  - Lower = larger features
  - Higher = finer detail
- **Octaves** (1-8, default: 4)
  - Number of noise layers to combine
  - More octaves = more detail
- **Persistence** (0.0 - 1.0, default: 0.5)
  - How much each octave contributes
  - Higher = rougher texture
- **Seed** (optional) - for reproducibility

**Use Cases:**
- Organic textures
- Cloud/smoke effects
- Natural-looking halftones

**Implementation Notes:**
- Use existing noise library (e.g., noisejs, simplex-noise)
- Normalize output to 0-255 range
- Can be computed in Web Worker for large sizes
- Consider caching noise function for performance

---

### 2.3 Ben-Day Dots Pattern

**Description:** Regular grid of circular dots, classic halftone printing style.

**Parameters:**
- **Dot Spacing** (pixels or physical units)
  - Distance between dot centers
  - Range: 2-100 pixels or 0.01-0.5 inches
- **Dot Size** (0.0 - 1.0, relative to spacing, default: 0.7)
  - 0.0 = no dots (white)
  - 1.0 = dots touch (maximum coverage)
- **Dot Shape**:
  - Circle (default)
  - Square
  - Diamond
  - Ellipse (requires orientation parameter)
- **Grid Type**:
  - Square grid (default)
  - Hexagonal grid (more uniform coverage)
- **Anti-aliasing** (boolean, default: true)
  - Smooth dot edges vs sharp edges

**Use Cases:**
- Classic halftone printing simulation
- Comic book / pop art effects
- Controlled density patterns

**Implementation Notes:**
- For each pixel, calculate distance to nearest dot center
- Use SDF approach for clean circles/shapes
- Hexagonal grid: offset every other row by spacing/2
- Anti-aliasing: use sub-pixel sampling or distance-based smoothing
- Physical spacing: convert from inches to pixels using DPI

---

## 3. User Interface Updates

### 3.1 Pattern Selection

**Update pattern dropdown:**
```html
<select id="pattern-select">
    <option value="random">Random</option>
    <option value="noise">Noise</option>
    <option value="benday">Ben-Day Dots</option>
    <option value="hilbert">Hilbert Curve</option>
</select>
```

### 3.2 Dynamic Parameter Controls

**Approach:** Show/hide parameter controls based on selected pattern.

**Random Pattern Controls:**
- Distribution type selector (uniform/normal/binary)
- Seed input (optional, number)

**Noise Pattern Controls:**
- Scale slider (0.1 - 10.0, step 0.1)
- Octaves slider (1-8, step 1)
- Persistence slider (0.0 - 1.0, step 0.05)
- Seed input (optional, number)

**Ben-Day Dots Controls:**
- Dot Spacing input (with unit - pixels or inches)
- Dot Size slider (0.0 - 1.0, step 0.05)
- Dot Shape selector (circle/square/diamond)
- Grid Type selector (square/hexagonal)
- Anti-aliasing checkbox

**UI Pattern:**
```javascript
function updateParameterControls(patternType) {
    // Hide all parameter groups
    hideAll();

    // Show relevant group
    if (patternType === 'random') {
        showRandomControls();
    } else if (patternType === 'noise') {
        showNoiseControls();
    } else if (patternType === 'benday') {
        showBendayControls();
    }
}
```

---

## 4. Technical Design

### 4.1 Pattern Generator Interface

**Unified interface for all patterns:**

```javascript
class PatternGenerator {
    /**
     * Generate pattern with given configuration
     * @param {Object} config - Pattern configuration
     * @param {number} config.width - Width in pixels
     * @param {number} config.height - Height in pixels
     * @param {Object} config.params - Pattern-specific parameters
     * @param {Function} onProgress - Progress callback (0-1)
     * @param {Object} cancelToken - Cancellation token
     * @returns {ImageData} Generated pattern
     */
    static generate(config, onProgress, cancelToken) {
        // Dispatch to specific generator
    }
}
```

### 4.2 Random Pattern Implementation

```javascript
function generateRandomPattern(width, height, params, onProgress, cancelToken) {
    const imageData = new ImageData(width, height);
    const data = imageData.data;
    const { distribution, seed } = params;

    const rng = seed ? seededRandom(seed) : Math.random;
    const chunkSize = 1000; // pixels per progress update

    for (let i = 0; i < data.length; i += 4) {
        if (cancelToken.cancelled) throw new Error('Cancelled');

        let value;
        if (distribution === 'binary') {
            value = rng() < 0.5 ? 0 : 255;
        } else if (distribution === 'normal') {
            value = normalRandom(rng, 128, 50); // mean=128, stddev=50
        } else {
            value = Math.floor(rng() * 256);
        }

        data[i] = data[i+1] = data[i+2] = value;
        data[i+3] = 255; // alpha

        if (i % (chunkSize * 4) === 0) {
            onProgress(i / data.length);
        }
    }

    return imageData;
}
```

### 4.3 Noise Pattern Implementation

**Use existing noise library:**

```javascript
import { createNoise2D } from 'simplex-noise';

function generateNoisePattern(width, height, params, onProgress, cancelToken) {
    const { scale, octaves, persistence, seed } = params;
    const noise2D = createNoise2D(seed ? seededRandom(seed) : Math.random);

    const imageData = new ImageData(width, height);
    const data = imageData.data;

    for (let y = 0; y < height; y++) {
        if (cancelToken.cancelled) throw new Error('Cancelled');

        for (let x = 0; x < width; x++) {
            let value = 0;
            let amplitude = 1;
            let frequency = scale;
            let maxValue = 0;

            // Combine octaves
            for (let octave = 0; octave < octaves; octave++) {
                value += noise2D(x * frequency, y * frequency) * amplitude;
                maxValue += amplitude;
                amplitude *= persistence;
                frequency *= 2;
            }

            // Normalize to 0-255
            const normalized = ((value / maxValue) + 1) / 2; // -1..1 to 0..1
            const gray = Math.floor(normalized * 255);

            const idx = (y * width + x) * 4;
            data[idx] = data[idx+1] = data[idx+2] = gray;
            data[idx+3] = 255;
        }

        onProgress(y / height);
    }

    return imageData;
}
```

### 4.4 Ben-Day Dots Implementation

**SDF-based circular dots:**

```javascript
function generateBendayPattern(width, height, params, onProgress, cancelToken) {
    const { spacing, dotSize, shape, gridType, antialiasing, dpi } = params;

    // Convert spacing from physical to pixels if needed
    const spacingPx = params.spacingUnit === 'inches'
        ? spacing * dpi
        : spacing;

    const imageData = new ImageData(width, height);
    const data = imageData.data;
    const radius = (spacingPx / 2) * dotSize;

    for (let y = 0; y < height; y++) {
        if (cancelToken.cancelled) throw new Error('Cancelled');

        for (let x = 0; x < width; x++) {
            // Find nearest dot center
            let nearestDist = Infinity;

            if (gridType === 'square') {
                const gridX = Math.round(x / spacingPx) * spacingPx;
                const gridY = Math.round(y / spacingPx) * spacingPx;
                nearestDist = distance(x, y, gridX, gridY);
            } else if (gridType === 'hexagonal') {
                // Hexagonal grid calculation
                nearestDist = hexGridDistance(x, y, spacingPx);
            }

            // Calculate dot value based on distance
            let value;
            if (shape === 'circle') {
                const sdf = nearestDist - radius;
                if (antialiasing) {
                    value = smoothstep(1, -1, sdf); // smooth edge
                } else {
                    value = sdf < 0 ? 1 : 0; // sharp edge
                }
            } else if (shape === 'square') {
                // Square SDF implementation
            }

            const gray = Math.floor(value * 255);
            const idx = (y * width + x) * 4;
            data[idx] = data[idx+1] = data[idx+2] = gray;
            data[idx+3] = 255;
        }

        onProgress(y / height);
    }

    return imageData;
}

function smoothstep(edge0, edge1, x) {
    const t = Math.max(0, Math.min(1, (x - edge0) / (edge1 - edge0)));
    return t * t * (3 - 2 * t);
}
```

---

## 5. File Structure

**New files:**
```
patterns/
  random-pattern.js       - Random pattern generator
  noise-pattern.js        - Noise pattern generator
  benday-pattern.js       - Ben-day dots generator
  pattern-factory.js      - Pattern selection/dispatch

utils/
  noise-lib.js           - Noise library (simplex-noise wrapper)
  prng.js                - Seeded random number generator
```

**Modified files:**
```
index.html              - Add new pattern controls
styles.css              - Style for parameter groups
app.js                  - Wire up pattern selection
workers/pattern-worker.js - Update to use new generators
```

---

## 6. Implementation Phases

### Phase 1: Random Pattern (Simplest)
**Tasks:**
1. Create random-pattern.js with generator function
2. Implement seeded PRNG utility (prng.js)
3. Add distribution types (uniform, normal, binary)
4. Add UI controls for random pattern
5. Wire up to pattern-worker.js
6. Test generation and export

**Estimated effort:** 2-3 hours

---

### Phase 2: Noise Pattern
**Tasks:**
1. Add simplex-noise library dependency
2. Create noise-pattern.js generator
3. Implement octave layering
4. Add UI controls for noise parameters
5. Wire up to pattern system
6. Test with various parameter combinations

**Estimated effort:** 3-4 hours

---

### Phase 3: Ben-Day Dots Pattern
**Tasks:**
1. Create benday-pattern.js generator
2. Implement square grid layout
3. Implement circular dot SDF
4. Add anti-aliasing
5. Implement hexagonal grid layout
6. Add alternative shapes (square, diamond)
7. Add UI controls
8. Wire up to pattern system
9. Test with physical spacing units

**Estimated effort:** 4-5 hours

---

### Phase 4: Integration & Polish
**Tasks:**
1. Create pattern-factory.js for clean dispatching
2. Update pattern dropdown UI
3. Implement dynamic parameter control showing/hiding
4. Update PDF metadata to include pattern-specific params
5. Test all patterns with analysis tool
6. Test all patterns with PDF export
7. Add helpful tooltips/descriptions
8. Performance testing (ensure 4K generation in <5s)

**Estimated effort:** 2-3 hours

---

## 7. Testing Plan

### 7.1 Unit Tests

**Random Pattern:**
- Verify all pixels are within 0-255
- Test seed reproducibility
- Verify distribution types produce expected histograms

**Noise Pattern:**
- Verify smooth gradients
- Test octave layering
- Verify seed reproducibility
- Test scale parameter effects

**Ben-Day Dots:**
- Verify dot spacing is correct
- Test physical unit conversion
- Verify grid types produce expected layouts
- Test dot size parameter
- Verify anti-aliasing smoothness

### 7.2 Integration Tests

**With Size System:**
- Generate patterns in pixel mode
- Generate patterns in physical mode
- Verify correct dimensions

**With Export:**
- Export patterns as PNG
- Export patterns as PDF
- Verify metadata is correct

**With Analysis:**
- Analyze random pattern (should show ~50% darkness)
- Analyze noise pattern at various scales
- Analyze ben-day dots at various sizes
- Verify overlay rendering works

### 7.3 Visual Verification

**Manual checks:**
- Random pattern looks random
- Noise pattern has smooth gradients
- Ben-day dots are evenly spaced
- Square grid is aligned
- Hexagonal grid has proper offset
- Anti-aliasing is smooth
- Shapes are correct

---

## 8. Performance Considerations

**Target:** All patterns generate 4K (4096x4096) in <5 seconds

**Optimizations:**
- Use typed arrays for pixel data
- Minimize distance calculations in ben-day (use spatial partitioning)
- Pre-calculate noise samples for common parameters
- Use Web Worker for all generation
- Chunked processing for progress updates
- Consider SharedArrayBuffer for faster data transfer

**Benchmarks to track:**
- 1K × 1K: <500ms
- 2K × 2K: <2s
- 4K × 4K: <5s

---

## 9. Dependencies

**External Libraries:**

1. **simplex-noise** (for noise pattern)
   - CDN: `https://cdn.skypack.dev/simplex-noise@4.0.1`
   - Or npm: `simplex-noise`
   - Size: ~5KB minified
   - License: Public domain / Unlicense

2. **seedrandom** (for reproducible random)
   - CDN: `https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js`
   - Size: ~3KB minified
   - License: MIT

**Total additional dependencies: ~8KB**

---

## 10. Acceptance Criteria

**Random Pattern:**
- ✓ Generates pure random pixels
- ✓ Supports uniform, normal, and binary distributions
- ✓ Seed produces reproducible results
- ✓ Works with all export formats

**Noise Pattern:**
- ✓ Produces smooth, continuous gradients
- ✓ Scale parameter works (0.1 - 10.0)
- ✓ Octaves parameter works (1-8)
- ✓ Persistence parameter works (0.0 - 1.0)
- ✓ Seed produces reproducible results
- ✓ No visible artifacts or banding

**Ben-Day Dots:**
- ✓ Dots are evenly spaced
- ✓ Square grid is properly aligned
- ✓ Hexagonal grid has correct offset
- ✓ Dot size parameter works (0.0 - 1.0)
- ✓ Spacing works in both pixels and inches
- ✓ Anti-aliasing produces smooth edges
- ✓ Sharp mode produces crisp edges
- ✓ Circle, square, and diamond shapes work
- ✓ No moiré patterns or aliasing issues

**Integration:**
- ✓ Pattern dropdown selects all patterns
- ✓ Parameter controls show/hide correctly
- ✓ All patterns work with size specification system
- ✓ All patterns export to PNG correctly
- ✓ All patterns export to PDF with correct metadata
- ✓ All patterns work with darkness analysis
- ✓ Progress feedback works for all patterns
- ✓ Cancellation works for all patterns
- ✓ Performance target met (<5s for 4K)

---

## 11. Documentation Updates

**Files to update:**
- README.md - Add new patterns to features list
- architecture.md - Document pattern system
- Example images for each pattern type
- Parameter descriptions and recommended values

---

## 12. Future Enhancements

**Potential additions (not in scope for this feature):**
- Gradient dots (varying size based on position)
- Angled dot screens (classic CMYK separation angles)
- Custom dot patterns from image
- Multiple dot shapes mixed
- Animated/evolving noise
- 3D noise (for video)

---

**Planning Document Version:** 1.0
**Last Updated:** 2025-01-19
**Next Review:** After Phase 1 completion
